diff -Nur -x '*.orig' -x '*.rej' smeserver-audittools-0.0.1/root/sbin/e-smith/audittools/pseudonyms mezzanine_patched_smeserver-audittools-0.0.1/root/sbin/e-smith/audittools/pseudonyms
--- smeserver-audittools-0.0.1/root/sbin/e-smith/audittools/pseudonyms	1970-01-01 10:00:00.000000000 +1000
+++ mezzanine_patched_smeserver-audittools-0.0.1/root/sbin/e-smith/audittools/pseudonyms	2006-03-30 10:38:37.135351641 +1000
@@ -0,0 +1,69 @@
+#!/usr/bin/perl -w
+
+#----------------------------------------------------------------------
+# copyright (C) 1999-2006 Mitel Corporation
+# copyright (C) 2006 Gordon Rowell <gordonr@gormand.com.au>
+#
+# This program is free software; you can redistribute it and/or modify
+# it under the terms of the GNU General Public License as published by
+# the Free Software Foundation; either version 2 of the License, or
+# (at your option) any later version.
+#
+# This program is distributed in the hope that it will be useful,
+# but WITHOUT ANY WARRANTY; without even the implied warranty of
+# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+# GNU General Public License for more details.
+#
+# You should have received a copy of the GNU General Public License
+# along with this program; if not, write to the Free Software
+# Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307  USA
+#----------------------------------------------------------------------
+
+use strict;
+use warnings;
+
+use esmith::AccountsDB;
+
+my $adb = esmith::AccountsDB->open_ro or die "Couldn't open AccountsDB\n";
+
+for my $pseudonym ($adb->pseudonyms)
+{
+    my $account = $pseudonym->prop('Account');
+    my $key = $pseudonym->key;
+
+    unless ($account)
+    {
+        complain($key, "no Account property");
+        next;
+    }
+
+    $account = $adb->get($pseudonym->prop('Account'));
+    unless ($account)
+    {
+        complain($key, "points to account which does not exist");
+        next;
+    }
+
+    $account = $adb->get($account->prop('Account')) 
+        if ($account->prop('type') eq "pseudonym");
+
+    unless ($account)
+    {
+        complain($key, "points to pseudonym account which points to account which does not exist");
+        next;
+    }
+
+    if ($account->prop('type') eq "pseudonym")
+    {
+        complain($key, "too many pseudonym levels");
+        next;
+    }
+}
+
+sub complain
+{
+    my ($key, $warning) = @_;
+
+    warn "$key: $warning\n";
+    warn "RUN: db settype pseudonym-deleted $key\n"
+}
